# Cachi2

[![coverage][cachi2-coveralls-badge]][cachi2-coveralls]

Cachi2 is a CLI tool that pre-fetches your project's dependencies to aid in making your build process
[hermetic](https://slsa.dev/spec/v0.1/requirements#hermetic).

The primary intended use of Cachi2's outputs is for network-isolated container builds (see [usage](docs/usage.md)).

## Table of contents

* [Supported package managers](#supported-package-managers-so-far)
* [Goals](#goals)
* [Basic usage](#basic-usage)
* [Development](#development)
* [Project status](#project-status)

## Supported package managers (so far)

* [Go modules](https://go.dev/ref/mod)

## Goals

Please note that Cachi2 is rather picky, aiming to:

* encourage or enforce best practices
* enforce building from source - no pre-built artifacts, such as Python [wheels][wheel-spec]
* never execute arbitrary code - looking at you [setup.py (discouraged)][setuppy-discouraged]
* keep the implementation simple

To play nicely with Cachi2, the build process for your project must be

* **Defined** - Cachi2 only fetches dependencies that are explicitly declared - typically in a lockfile generated by
  your package manager.
* **Reproducible** - Cachi2 will refuse to fetch a dependency if it's not pinned to an exact version. This goes
  for transitive dependencies as well (and ties to the Defined point). Most package managers pin all dependencies
  automatically in lockfiles.
* **Secure** - Even with a lockfile, your build is not truly safe from supply chain attacks unless you verify the
  checksums of all dependencies. If your package manager supports specifying the expected checksums, we strongly
  encourage you to make use of them.

  âš  Cachi2 will verify checksums if present, but doesn't require them by default. This may change in the future.

In return, Cachi2 will help make your build

* **Auditable** - by generating a manifest of all the dependencies that go into your build.

The ability to achieve the goals depends on the hermeticity of the build process. Ideally, you should try to isolate the
build from both the internet and the underlying host system to avoid implicit dependencies, irreproducible behavior and
whole hosts of other issues. Cachi2 itself is not a hermetic build system. We suggest you take advantage of existing
technologies - such as containers - to achieve isolation (see [usage](docs/usage.md)).

## Basic usage

```shell
cachi2 fetch-deps \
  --source ./my-repo \
  --output ./cachi2-output \
  --package gomod
```

The `fetch-deps` command fetches your project's dependencies and stores them on your disk. You can then use these
outputs to, say, build a container image.

See [docs/usage.md](docs/usage.md) for a more detailed, practical (*cough*) example of Cachi2 usage.

You might also like to check out `cachi2 --help` and the `--help` texts of the available subcommands.

## Development

### Virtualenv

Set up a virtual environment that has everything you will need for development:

```shell
make venv
source venv/bin/activate
```

This installs the Cachi2 CLI in [editable mode](https://setuptools.pypa.io/en/latest/userguide/development_mode.html),
which means changes to the source code will reflect in the behavior of the CLI without the need for reinstalling.

You may need to install the following dependencies before creating the virtualenv:

```shell
dnf install python3.9 python3-virtualenv
```

The CLI also depends on the following non-Python dependencies:

```shell
dnf install golang-bin git
```

You should now have everything needed to [try out](#basic-usage) the CLI or hack on the code in ~~vim~~ your favorite
editor.

### Coding standards

Cachi2's codebase conforms to standards enforced by a collection of formatters, linters and other code checkers:

* [black](https://black.readthedocs.io/en/stable/) (with a line-length of 100) for consistent formatting
* [isort](https://pycqa.github.io/isort/) to keep imports sorted
* [flake8](https://flake8.pycqa.org/en/latest/) to (de-)lint the code and ~~politely~~ ask for docstrings
* [mypy](https://mypy.readthedocs.io/en/stable/) for type-checking. Please include type annotations for new code.
* [pytest](https://docs.pytest.org/en/7.1.x/) to run unit tests and report coverage stats. Please aim for (near) full
  coverage of new code.

Options for all the tools are configured in [pyproject.toml](./pyproject.toml) and [tox.ini](./tox.ini).

Run all the checks that your pull request will be subjected to:

```shell
make test
```

### Running unit tests

Run all unit tests (but no other checks):

```shell
make test-unit
```

For finer control over which tests get executed, e.g. to run all tests in a specific file, activate
the [virtualenv](#virtualenv) and run:

```shell
tox -e python3.9 -- tests/unit/test_cli.py
```

Even better, run it stepwise (exit on first failure, re-start from the failed test next time):

```shell
tox -e python3.9 -- tests/unit/test_cli.py --stepwise
```

You can also run a single test class or a single test method:

```shell
tox -e python3.9 -- tests/unit/test_cli.py::TestGenerateEnv
tox -e python3.9 -- tests/unit/test_cli.py::TestGenerateEnv::test_invalid_format
tox -e python3.9 -- tests/unit/extras/test_envfile.py::test_cannot_determine_format
```

In short, tox passes all arguments to the right of `--` directly to pytest.

## Project status

Cachi2 was derived (but is not a direct fork) from [Cachito](https://github.com/containerbuildsystem/cachito) and is
still in early development phase.

[cachi2-coveralls]: https://coveralls.io/github/containerbuildsystem/cachi2?branch=main
[cachi2-coveralls-badge]: https://coveralls.io/repos/github/containerbuildsystem/cachi2/badge.svg?branch=main
[wheel-spec]: https://packaging.python.org/en/latest/specifications/binary-distribution-format/
[setuppy-discouraged]: https://setuptools.pypa.io/en/latest/userguide/quickstart.html#setuppy-discouraged
